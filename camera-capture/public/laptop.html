<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Laptop Viewer</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        padding: 16px;
      }
      #videoWrap video {
        width: 100%;
        max-width: 720px;
        background: #111;
        border-radius: 12px;
      }
    </style>
  </head>
  <body>
    <h2>Laptop Viewer (Auto-save every 30s)</h2>
    <button id="connect">Connect</button>
    <p id="status">Idle</p>

    <div id="videoWrap"></div>

    <script type="module">
      import { Room } from "https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.esm.mjs";

      const status = document.getElementById("status");
      const connectBtn = document.getElementById("connect");
      const wrap = document.getElementById("videoWrap");

      const SNAP_EVERY_MS = 30 * 1000; // 30 seconds

      let room;
      let attachedVideoEl = null;
      let timerStarted = false;

      async function getToken(identity) {
        const r = await fetch(`/token?identity=${encodeURIComponent(identity)}&t=${Date.now()}`);
        if (!r.ok) throw new Error("token fetch failed: " + r.status);
        return r.json();
      }

      function attachTrack(track) {
        if (attachedVideoEl) {
          attachedVideoEl.remove();
          attachedVideoEl = null;
        }

        attachedVideoEl = track.attach();
        attachedVideoEl.autoplay = true;
        attachedVideoEl.playsInline = true;
        attachedVideoEl.muted = true;

        wrap.innerHTML = "";
        wrap.appendChild(attachedVideoEl);

        track.on("unmuted", () => {
          const el = track.attach();
          wrap.innerHTML = "";
          wrap.appendChild(el);
          attachedVideoEl = el;
        });
      }

      async function snapAndUpload() {
        if (!attachedVideoEl || !attachedVideoEl.videoWidth || !attachedVideoEl.videoHeight) {
          return;
        }

        const canvas = document.createElement("canvas");
        canvas.width = attachedVideoEl.videoWidth;
        canvas.height = attachedVideoEl.videoHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(attachedVideoEl, 0, 0);

        const blob = await new Promise((resolve) =>
          canvas.toBlob(resolve, "image/jpeg", 0.85)
        );
        if (!blob) return;

        const fd = new FormData();
        fd.append("photo", blob, "circuit.jpg");

        const up = await fetch("/upload", { method: "POST", body: fd });
        if (up.ok) {
          status.textContent =
            "Saved image @ " + new Date().toLocaleTimeString();
        }
      }

      connectBtn.onclick = async () => {
        try {
          status.textContent = "Getting token...";
          const data = await getToken("laptop");

          status.textContent = "Connecting to LiveKit...";
          room = new Room({ adaptiveStream: false, dynacast: false });
          await room.connect(data.url, data.token);

          status.textContent = "Waiting for phone video...";
          connectBtn.disabled = true;

          room.on("trackSubscribed", (track) => {
            if (track.kind === "video") {
              attachTrack(track);
              status.textContent = "Video connected âœ“";

              if (!timerStarted) {
                timerStarted = true;
                setInterval(snapAndUpload, SNAP_EVERY_MS);
              }
            }
          });
        } catch (e) {
          console.error(e);
          status.textContent = "Connect failed: " + e.message;
        }
      };
    </script>
  </body>
</html>
