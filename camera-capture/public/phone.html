<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Phone Publisher</title>
  </head>
  <body>
    <h2>Phone Camera Publisher</h2>
    <button id="start">Start camera</button>
    <p id="status">Idle</p>

    <script type="module">
        import { Room, createLocalVideoTrack } from "https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.esm.mjs";

        const status = document.getElementById("status");
        const startBtn = document.getElementById("start");

        startBtn.onclick = async () => {
            try {
            status.textContent = "Getting token...";
            
            // Use local server token endpoint
            const tokenUrl = `${window.location.protocol}//${window.location.hostname}:3000/token?identity=phone&t=${Date.now()}`;
            const r = await fetch(tokenUrl, { method: "GET" });

            if (!r.ok) {
                const text = await r.text();
                throw new Error(`Token fetch failed: ${r.status} - ${text}`);
            }

            const data = await r.json();

            status.textContent = `Connecting to LiveKit... (${data.url})`;
            const lkRoom = new Room({
                adaptiveStream: true,
                dynacast: true,
            });

            await lkRoom.connect(data.url, data.token);

            status.textContent = "Starting camera...";
            const track = await createLocalVideoTrack({ facingMode: "environment" });
            await lkRoom.localParticipant.publishTrack(track);

            status.textContent = `Publishing âœ“ Room: ${data.room}`;
            startBtn.disabled = true;
            } catch (e) {
            console.error(e);
            status.textContent =
                "LiveKit connect failed: " + (e?.message || String(e));
            }
        };
        </script>

  </body>
</html>
